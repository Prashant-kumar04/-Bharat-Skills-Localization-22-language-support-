<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bharat Skills - AI Localization Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .hero-gradient-text {
            background: linear-gradient(to right, var(--primary-color), var(--primary-hover));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn-primary:disabled {
            background-color: #94a3b8; /* slate-400 */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0; /* slate-200 */
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05);
        }
        select, textarea, input {
            border-color: #cbd5e1; /* slate-300 */
            transition: all 0.2s ease;
        }
        select:focus, textarea:focus, input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
            outline: none;
        }
        .content-type-btn {
            border: 2px solid #e2e8f0;
            transition: all 0.2s ease-in-out;
        }
        .content-type-btn.active {
            border-color: var(--primary-color);
            background-color: #eff6ff; /* blue-50 */
            color: var(--primary-color);
        }
        .mic-btn.recording {
            color: #ef4444; /* red-500 */
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .audio-player-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Styles for the dictation modal */
        #dictation-modal-mic {
            animation: pulse-mic 2s infinite;
        }
        @keyframes pulse-mic {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 20px rgba(37, 99, 235, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-slate-200">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://placehold.co/40x40/2563EB/FFFFFF?text=BS" alt="Bharat Skills Logo" class="rounded-lg">
                    <h1 class="text-xl font-bold text-slate-800 hidden sm:block">Bharat Skills Localization</h1>
                </div>
                <a href="#input-view" class="btn-primary px-5 py-2 rounded-full font-semibold text-sm">Start Localizing</a>
            </div>
        </header>

        <!-- Hero Section -->
        <section class="bg-white">
            <div class="container mx-auto px-6 pt-20 pb-16 text-center">
                <h2 class="text-4xl md:text-6xl font-extrabold mb-4 text-slate-900 tracking-tight">
                    The Future of <span class="hero-gradient-text">Skill Training is Here</span>
                </h2>
                <p class="text-lg text-slate-600 mb-10 max-w-3xl mx-auto">
                    Leveraging Gemini AI to instantly translate and adapt any vocational content—text, documents, and multimedia—for every learner in India.
                </p>
            </div>
        </section>

        <!-- Main Application -->
        <main class="container mx-auto px-6 py-12 flex-grow -mt-16">
            <div id="input-view" class="max-w-6xl mx-auto space-y-6">
                <!-- Step 1: Content Type -->
                <div class="card p-6">
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-3 mb-4">
                        <span class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">1</span>
                        Choose Content Type
                    </h3>
                    <div id="content-type-selector" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button data-type="text" class="content-type-btn active flex flex-col items-center justify-center p-4 rounded-lg font-semibold text-slate-600">
                            <i data-lucide="file-text" class="w-8 h-8 mb-2"></i> Text
                        </button>
                        <button data-type="document" class="content-type-btn flex flex-col items-center justify-center p-4 rounded-lg font-semibold text-slate-600">
                            <i data-lucide="file-check-2" class="w-8 h-8 mb-2"></i> Document
                        </button>
                        <button data-type="audio" class="content-type-btn flex flex-col items-center justify-center p-4 rounded-lg font-semibold text-slate-600">
                            <i data-lucide="audio-lines" class="w-8 h-8 mb-2"></i> Audio/Video
                        </button>
                        <button data-type="assessment" class="content-type-btn flex flex-col items-center justify-center p-4 rounded-lg font-semibold text-slate-600">
                            <i data-lucide="clipboard-list" class="w-8 h-8 mb-2"></i> Assessment
                        </button>
                    </div>
                </div>

                <!-- Step 2: Configuration -->
                <div class="card p-6">
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-3 mb-4">
                       <span class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">2</span>
                        Configure Localization
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Language Selector -->
                        <div>
                            <label for="target-language" class="block text-sm font-medium text-slate-700 mb-2">Target Language <span class="text-red-500">*</span></label>
                            <select id="target-language" class="w-full p-3 rounded-md border text-slate-700 bg-white">
                                <option value="">Choose a language...</option>
                                <option value="English">English</option>
                                <!-- 22 Scheduled Languages of India -->
                                <option value="Assamese">Assamese</option> <option value="Bengali">Bengali</option> <option value="Bodo">Bodo</option> <option value="Dogri">Dogri</option> <option value="Gujarati">Gujarati</option> <option value="Hindi">Hindi</option> <option value="Kannada">Kannada</option> <option value="Kashmiri">Kashmiri</option> <option value="Konkani">Konkani</option> <option value="Maithili">Maithili</option> <option value="Malayalam">Malayalam</option> <option value="Manipuri">Manipuri</option> <option value="Marathi">Marathi</option> <option value="Nepali">Nepali</option> <option value="Odia">Odia</option> <option value="Punjabi">Punjabi</option> <option value="Sanskrit">Sanskrit</option> <option value="Santali">Santali</option> <option value="Sindhi">Sindhi</option> <option value="Tamil">Tamil</option> <option value="Telugu">Telugu</option> <option value="Urdu">Urdu</option>
                            </select>
                        </div>
                        <!-- Skill Domain Selector -->
                        <div>
                            <label for="skill-domain" class="block text-sm font-medium text-slate-700 mb-2">Skill Domain <span class="text-red-500">*</span></label>
                            <select id="skill-domain" class="w-full p-3 rounded-md border text-slate-700 bg-white">
                                 <option value="">Select a skill domain...</option>
                                 <option value="Plumbing & Pipe Fitting">Plumbing & Pipe Fitting</option>
                                 <option value="Tailoring & Garment Making">Tailoring & Garment Making</option>
                                 <option value="IT Support & Computer Skills">IT Support & Computer Skills</option>
                                 <option value="Electrical Work">Electrical Work</option>
                                 <option value="Welding & Fabrication">Welding & Fabrication</option>
                                 <option value="Automotive Repair">Automotive Repair</option>
                                 <option value="Agriculture & Farming">Agriculture & Farming</option>
                                 <option value="Healthcare Assistant">Healthcare Assistant</option>
                                 <option value="Construction & Masonry">Construction & Masonry</option>
                                 <option value="Beauty & Wellness">Beauty & Wellness</option>
                                 <option value="Food Processing & Catering">Food Processing & Catering</option>
                            </select>
                        </div>
                        <!-- Cultural Context Selector -->
                         <div>
                            <label for="cultural-context" class="block text-sm font-medium text-slate-700 mb-2">Cultural Context</label>
                            <select id="cultural-context" class="w-full p-3 rounded-md border text-slate-700 bg-white">
                                <option value="Neutral">Neutral / General</option> <option value="North India">North India</option> <option value="South India">South India</option> <option value="East India">East India</option> <option value="West India">West India</option> <option value="Formal/Official">Formal / Official Tone</option> <option value="Informal/Colloquial">Informal / Colloquial Tone</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Input Content -->
                 <div class="card p-6">
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-3 mb-4">
                       <span class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">3</span>
                        Provide Content
                    </h3>
                    <!-- Text Input Area -->
                    <div id="text-input-container">
                        <div class="relative">
                           <textarea id="input-text" rows="10" placeholder="Type or paste your English training content here... or use the microphone to dictate." class="w-full p-4 pr-12 rounded-md border"></textarea>
                           <button id="mic-btn" title="Start Dictation" class="mic-btn absolute top-3 right-3 text-slate-500 hover:text-blue-600 p-1">
                               <i data-lucide="mic" class="w-6 h-6"></i>
                           </button>
                        </div>
                    </div>
                    <!-- File Input Area -->
                    <div id="file-input-container" class="hidden">
                        <div class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center">
                            <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto text-slate-400 mb-4"></i>
                            <h4 class="font-semibold text-slate-700" id="file-input-title">Upload your Document</h4>
                            <p class="text-slate-500 text-sm mb-4" id="file-input-desc">PDF, DOCX, or PPTX files are supported.</p>
                            <input type="file" id="file-upload" class="hidden">
                            <button onclick="document.getElementById('file-upload').click()" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold px-4 py-2 rounded-md">Choose File</button>
                            <p id="file-name" class="mt-4 font-medium text-green-700"></p>
                        </div>
                    </div>
                </div>

                <!-- Action Button -->
                <div class="text-center pt-4">
                    <button id="translate-btn" class="btn-primary font-bold text-lg px-12 py-4 rounded-full inline-flex items-center gap-3 w-full sm:w-auto justify-center">
                        <span id="btn-text">
                            <i data-lucide="languages" class="w-6 h-6 inline-block -mt-1"></i>
                            Localize My Content
                        </span>
                        <div id="loader" class="hidden w-6 h-6 border-4 border-t-transparent border-white rounded-full animate-spin"></div>
                    </button>
                    <p id="error-message" class="text-red-600 mt-4 font-medium hidden"></p>
                </div>
            </div>

            <!-- Output View -->
            <div id="output-view" class="hidden max-w-6xl mx-auto space-y-6">
                 <div class="flex flex-wrap justify-between items-center gap-4">
                    <h2 class="text-3xl font-bold text-slate-800">Localization Complete</h2>
                    <button id="new-translation-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold px-6 py-3 rounded-full flex items-center gap-2">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        Localize More Content
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 items-start">
                    <div class="lg:col-span-3 space-y-6">
                        <!-- Translated Text Card -->
                        <div class="card">
                             <div class="p-4 border-b flex justify-between items-center">
                                <h3 id="output-title" class="text-lg font-bold text-slate-800 flex items-center gap-3">
                                    <i data-lucide="book-open-check" class="w-6 h-6 text-blue-600"></i>
                                    <span>Localized Content</span>
                                </h3>
                                <button id="audio-player-btn" class="audio-player-btn flex items-center gap-2 font-semibold text-blue-600 hover:text-blue-800 disabled:text-slate-400">
                                     <i id="audio-icon" data-lucide="play-circle" class="w-6 h-6"></i>
                                     <span id="audio-text">Listen</span>
                                </button>
                             </div>
                             <div class="p-6">
                                <p id="translated-text" class="text-base text-slate-700 leading-relaxed whitespace-pre-wrap"></p>
                             </div>
                        </div>

                        <!-- Suggested Quiz Card -->
                        <div class="card">
                             <div class="p-4 border-b flex items-center gap-3">
                                <i data-lucide="lightbulb" class="w-6 h-6 text-yellow-500"></i>
                                <h3 class="text-lg font-bold text-slate-800">Suggested Quiz Questions</h3>
                             </div>
                             <div id="suggested-quiz" class="p-6 space-y-4 text-slate-700"></div>
                        </div>
                    </div>

                    <!-- Details Card -->
                    <div class="lg:col-span-2 card sticky top-24">
                        <div class="p-4 border-b flex items-center gap-3">
                            <i data-lucide="search-check" class="w-6 h-6 text-green-600"></i>
                            <h3 class="text-lg font-bold text-slate-800">Localization Details</h3>
                        </div>
                        <div class="p-6 space-y-6">
                            <div>
                                <h4 class="font-semibold text-slate-700 mb-3 flex items-center gap-2"><i data-lucide="wrench" class="w-5 h-5"></i>Glossary Terms Applied</h4>
                                <div id="glossary-terms" class="flex flex-wrap gap-2"></div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-slate-700 mb-3 flex items-center gap-2"><i data-lucide="map-pin" class="w-5 h-5"></i>Cultural Adaptations</h4>
                                <ul id="cultural-adaptations" class="list-disc pl-5 text-slate-600 space-y-1"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Dictation Modal -->
    <div id="dictation-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl p-8 text-center w-full max-w-lg m-4">
            <div id="dictation-modal-mic" class="w-24 h-24 bg-blue-600 text-white rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="mic" class="w-12 h-12"></i>
            </div>
            <h2 id="dictation-modal-title" class="text-2xl font-bold text-slate-800 mb-2">Listening...</h2>
            <p id="dictation-modal-status" class="text-slate-500 mb-4 h-5">Please start speaking now.</p>
            <p id="interim-transcript" class="text-slate-700 min-h-[48px]"></p>
            <button id="stop-dictation-btn" class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold px-8 py-3 rounded-full flex items-center gap-2 mx-auto">
                <i data-lucide="stop-circle" class="w-5 h-5"></i>
                Stop Listening
            </button>
        </div>
    </div>


    <script type="module">
        lucide.createIcons();

        // --- State Management ---
        let currentContentType = 'text';
        let isRecording = false;
        let recognition;
        let audioContext;
        let currentAudioBufferSource = null;
        let finalTranscript = '';

        // --- DOM Elements ---
        const contentTypeSelector = document.getElementById('content-type-selector');
        const textInputContainer = document.getElementById('text-input-container');
        const fileInputContainer = document.getElementById('file-input-container');
        const fileInputTitle = document.getElementById('file-input-title');
        const fileInputDesc = document.getElementById('file-input-desc');
        const fileUpload = document.getElementById('file-upload');
        const fileNameElem = document.getElementById('file-name');
        
        const micBtn = document.getElementById('mic-btn');
        const translateBtn = document.getElementById('translate-btn');
        const btnText = document.getElementById('btn-text');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        
        const inputView = document.getElementById('input-view');
        const outputView = document.getElementById('output-view');
        const newTranslationBtn = document.getElementById('new-translation-btn');
        
        const inputTextElem = document.getElementById('input-text');
        const targetLanguageElem = document.getElementById('target-language');
        const skillDomainElem = document.getElementById('skill-domain');
        const culturalContextElem = document.getElementById('cultural-context');

        // Modal elements
        const dictationModal = document.getElementById('dictation-modal');
        const dictationModalTitle = document.getElementById('dictation-modal-title');
        const dictationModalStatus = document.getElementById('dictation-modal-status');
        const interimTranscriptElem = document.getElementById('interim-transcript');
        const stopDictationBtn = document.getElementById('stop-dictation-btn');

        const translatedTextElem = document.getElementById('translated-text');
        const outputTitleElem = document.getElementById('output-title').querySelector('span');
        const glossaryTermsContainer = document.getElementById('glossary-terms');
        const culturalAdaptationsList = document.getElementById('cultural-adaptations');
        const suggestedQuizContainer = document.getElementById('suggested-quiz');
        
        const audioPlayerBtn = document.getElementById('audio-player-btn');
        const audioIcon = document.getElementById('audio-icon');
        const audioText = document.getElementById('audio-text');

        // --- API Config ---
        const apiKey = "AIzaSyA8bqEt2J_kmLFGsCs9iabHzrJAWubZVSk"; // Handled by environment
        const genAI_apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const tts_apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

        // --- Speech Recognition Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                dictationModalStatus.textContent = 'Please start speaking now.';
            };

            // This is the single source of truth for when recognition ends.
            recognition.onend = () => {
                // Only process if we were in a recording state.
                if (isRecording) {
                    isRecording = false;
                    dictationModal.classList.add('hidden');
                    if (finalTranscript) {
                        inputTextElem.value += (inputTextElem.value ? ' ' : '') + finalTranscript.trim();
                    }
                }
            };
            
            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript + '. ';
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                interimTranscriptElem.textContent = interimTranscript;
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'no-speech') {
                    dictationModalStatus.textContent = "Couldn't hear you. Please try again.";
                } else if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                    dictationModalStatus.textContent = "Microphone access denied. Please allow it in browser settings.";
                } else {
                    dictationModalStatus.textContent = `Error: ${event.error}. Please try again.`;
                }
            };
        } else {
            micBtn.style.display = 'none';
        }
        
        // --- Core Logic ---
        async function handleTranslate() {
            const inputText = (currentContentType === 'document' && fileUpload.files.length > 0) 
                ? `(Content from file: ${fileUpload.files[0].name}) ` + inputTextElem.value 
                : inputTextElem.value;
            const targetLanguage = targetLanguageElem.value;
            const skillDomain = skillDomainElem.value;

            if (!inputText.trim() || !targetLanguage || !skillDomain) {
                showError('Please provide content, target language, and skill domain.');
                return;
            }
            
            setLoadingState(true);
            
            const systemPrompt = buildSystemPrompt();
            const payload = {
                contents: [{ parts: [{ text: inputText }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            translatedText: { type: "STRING" },
                            glossaryTermsApplied: { type: "ARRAY", items: { type: "STRING" } },
                            culturalAdaptationsMade: { type: "ARRAY", items: { type: "STRING" } },
                            suggestedQuiz: {
                                type: "OBJECT",
                                properties: {
                                    question: { type: "STRING" },
                                    options: { type: "ARRAY", items: { type: "STRING" } },
                                    answer: { type: "STRING" }
                                }
                            }
                        },
                        required: ["translatedText", "glossaryTermsApplied", "culturalAdaptationsMade"]
                    }
                }
            };

            try {
                const result = await callApiWithBackoff(genAI_apiUrl, payload);
                const responseData = JSON.parse(result.candidates[0].content.parts[0].text);
                renderOutput(responseData, targetLanguage);
                switchToOutputView();
            } catch (error) {
                console.error('API Error:', error);
                showError('Failed to get a response from the AI. Please try again.');
            } finally {
                setLoadingState(false);
            }
        }

        function buildSystemPrompt() {
            const targetLanguage = targetLanguageElem.value;
            const skillDomain = skillDomainElem.value;
            const culturalContext = culturalContextElem.value;

            let prompt = `You are an expert AI localization engine for Indian vocational training content. Your task is to translate and adapt the user's text with high accuracy and cultural relevance.

            Instructions:
            1.  **Translate:** Translate the user's text into ${targetLanguage}.
            2.  **Adapt for Skill Domain:** The skill domain is '${skillDomain}'. You MUST use accurate technical terminology for this field in ${targetLanguage}.
            3.  **Adapt for Cultural Context:** The cultural context is '${culturalContext}'. Modify examples, idioms, or phrasing to be relatable for this region/tone.
            4.  **Generate a Quiz Question:** Based on the CORE concepts in the translated text, create one multiple-choice question with 3-4 options and specify the correct answer. This is for assessment purposes.
            5.  **Provide a Structured JSON Response:** You MUST return ONLY a valid JSON object matching the provided schema. Do not add any text before or after it.`;

            if(currentContentType === 'audio') {
                prompt += `\n6. **Format for Audio/Video:** The source is an audio/video file. Format the translated text as a script suitable for a voice-over or subtitles.`
            }
            if(currentContentType === 'assessment') {
                prompt += `\n6. **Focus on Assessment:** The source content is an assessment. Pay close attention to translating questions and options accurately without changing their meaning.`
            }

            return prompt;
        }

        async function handleTextToSpeech() {
            if (currentAudioBufferSource) {
                currentAudioBufferSource.stop();
                currentAudioBufferSource = null;
                resetAudioPlayerUI();
                return;
            }
            const textToSpeak = translatedTextElem.textContent;
            if (!textToSpeak) return;

            setAudioPlayerUI('loading');

            const payload = {
                contents: [{ parts: [{ text: textToSpeak }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Sadaltager" } } }
                },
            };
            
            try {
                const result = await callApiWithBackoff(tts_apiUrl, payload);
                const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (!audioData) throw new Error("No audio data in response.");
                
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                // The API returns audio at 24000 Hz sample rate
                playPcmData(pcm16, 24000);

            } catch(error) {
                console.error("TTS Error:", error);
                resetAudioPlayerUI();
                alert("Sorry, couldn't generate audio for this text.");
            }
        }

        // --- UI & State Changers ---
        function updateContentType(type) {
             currentContentType = type;
             document.querySelectorAll('.content-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
             });
             
             const isText = type === 'text';
             textInputContainer.style.display = isText ? 'block' : 'none';
             fileInputContainer.style.display = isText ? 'none' : 'block';
             inputTextElem.value = '';
             fileNameElem.textContent = '';
             fileUpload.value = '';

             if (type === 'document') {
                fileInputTitle.textContent = 'Upload your Document';
                fileInputDesc.textContent = 'PDF, DOCX, or PPTX files are supported.';
                inputTextElem.placeholder = "Optional: Add any specific instructions for processing the document here...";
                textInputContainer.style.display = 'block'; // Show for instructions
             } else if (type === 'audio') {
                fileInputTitle.textContent = 'Upload your Audio/Video File';
                fileInputDesc.textContent = 'MP3, WAV, or MP4 files are supported.';
             } else if (type === 'assessment') {
                fileInputTitle.textContent = 'Upload your Assessment File';
                fileInputDesc.textContent = 'Upload a file containing quiz questions (e.g., DOCX, TXT).';
             }
        }

        function renderOutput(data, language) {
            translatedTextElem.textContent = data.translatedText || "No translation available.";
            outputTitleElem.textContent = `Localized Content (${language})`;
            
            renderBadges(glossaryTermsContainer, data.glossaryTermsApplied, 'bg-blue-100 text-blue-800');
            renderList(culturalAdaptationsList, data.culturalAdaptationsMade);
            renderQuiz(suggestedQuizContainer, data.suggestedQuiz);
            resetAudioPlayerUI();
        }

        function renderBadges(container, items) {
            container.innerHTML = '';
            if (items && items.length > 0) {
                items.forEach(item => {
                    const badge = document.createElement('span');
                    badge.className = 'bg-blue-100 text-blue-800 text-sm font-medium mr-2 mb-2 px-2.5 py-1 rounded-full';
                    badge.textContent = item;
                    container.appendChild(badge);
                });
            } else {
                 container.innerHTML = `<span class="text-sm text-slate-500">None detected.</span>`;
            }
        }

        function renderList(container, items) {
            container.innerHTML = '';
            if (items && items.length > 0) {
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    container.appendChild(li);
                });
            } else {
                container.innerHTML = `<li class="list-none text-sm text-slate-500">No specific adaptations made.</li>`;
            }
        }

        function renderQuiz(container, quiz) {
            container.innerHTML = '';
            if (quiz && quiz.question) {
                const question = document.createElement('p');
                question.className = 'font-semibold mb-2';
                question.textContent = quiz.question;
                container.appendChild(question);

                const optionsList = document.createElement('ul');
                optionsList.className = 'space-y-1 pl-4';
                quiz.options.forEach(opt => {
                    const li = document.createElement('li');
                    li.textContent = opt;
                    if (opt === quiz.answer) {
                        li.innerHTML += ' <span class="text-green-600 font-bold">(Correct Answer)</span>';
                    }
                    optionsList.appendChild(li);
                });
                container.appendChild(optionsList);
            } else {
                container.innerHTML = `<p class="text-sm text-slate-500">No quiz question could be generated for this content.</p>`;
            }
        }
        
        function setLoadingState(isLoading) {
            translateBtn.disabled = isLoading;
            btnText.classList.toggle('hidden', isLoading);
            loader.classList.toggle('hidden', !isLoading);
            errorMessage.classList.add('hidden');
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function switchToOutputView() {
            inputView.style.display = 'none';
            outputView.style.display = 'block';
            window.scrollTo(0, 0);
        }

        function switchToInputView() {
            outputView.style.display = 'none';
            inputView.style.display = 'block';
            inputTextElem.value = '';
            fileNameElem.textContent = '';
            fileUpload.value = '';
            errorMessage.classList.add('hidden');
            if (currentAudioBufferSource) {
                currentAudioBufferSource.stop();
                currentAudioBufferSource = null;
            }
            resetAudioPlayerUI();
        }

        function startRecording() {
            if (!recognition || isRecording) return;
            
            finalTranscript = '';
            interimTranscriptElem.textContent = '';
            dictationModalStatus.textContent = 'Please start speaking now.';
            dictationModal.classList.remove('hidden');
            
            try {
                isRecording = true; // Set state immediately before calling start
                recognition.start();
            } catch (error) {
                isRecording = false; // Reset state on failure
                console.error("Speech recognition could not start:", error);
                dictationModalStatus.textContent = "Could not start microphone. Please check permissions.";
            }
        }
        
        function stopRecording() {
            // Only try to stop if we are currently recording.
            if (isRecording) {
                recognition.stop();
                // The onend event will handle hiding the modal and setting isRecording to false.
            }
        }
        
        // --- Audio Playback Helpers ---
        function setAudioPlayerUI(state) { // 'idle', 'loading', 'playing'
             audioPlayerBtn.disabled = state === 'loading';
             audioText.textContent = state === 'playing' ? 'Stop' : 'Listen';
             const iconName = state === 'playing' ? 'stop-circle' : 'play-circle';
             audioIcon.setAttribute('data-lucide', iconName);
             lucide.createIcons();
        }
        function resetAudioPlayerUI() { setAudioPlayerUI('idle'); }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function playPcmData(pcm16Data, sampleRate) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            const audioBuffer = audioContext.createBuffer(1, pcm16Data.length, sampleRate);
            const channelData = audioBuffer.getChannelData(0);

            // Convert Int16 data to Float32 range [-1, 1]
            for (let i = 0; i < pcm16Data.length; i++) {
                channelData[i] = pcm16Data[i] / 32768.0;
            }

            if (currentAudioBufferSource) { currentAudioBufferSource.stop(); }
            currentAudioBufferSource = audioContext.createBufferSource();
            currentAudioBufferSource.buffer = audioBuffer;
            currentAudioBufferSource.connect(audioContext.destination);
            currentAudioBufferSource.start();
            setAudioPlayerUI('playing');
            
            currentAudioBufferSource.onended = () => {
                currentAudioBufferSource = null;
                resetAudioPlayerUI();
            };
        }
        
        // --- API Call Helper ---
        async function callApiWithBackoff(url, payload, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }
        
        // --- Event Listeners ---
        contentTypeSelector.addEventListener('click', (e) => {
            const button = e.target.closest('.content-type-btn');
            if (button) updateContentType(button.dataset.type);
        });
        fileUpload.addEventListener('change', () => {
             if (fileUpload.files.length > 0) {
                fileNameElem.textContent = `Selected File: ${fileUpload.files[0].name}`;
             }
        });
        translateBtn.addEventListener('click', handleTranslate);
        newTranslationBtn.addEventListener('click', switchToInputView);
        micBtn.addEventListener('click', startRecording);
        stopDictationBtn.addEventListener('click', stopRecording);
        audioPlayerBtn.addEventListener('click', handleTextToSpeech);

        // Initial setup
        updateContentType('text');

    </script>
</body>
</html>